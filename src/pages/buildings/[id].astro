---
import "../../styles/global.css";
import { issueOptions } from "../../data/noticeData";
import { isAccessKeyValid, isBuildingAccessValid } from "../../lib/access";
import {
  formatResidentReportCount,
  loadBuildingSubmissions,
  type BuildingSubmission,
} from "../../lib/buildingDashboard";
import { submissionStatusLabels, type SubmissionStatus } from "../../lib/submissions";
import SeoHead from "../../components/SeoHead.astro";

export const prerender = false;

const { id } = Astro.params;
const kv = Astro.locals.runtime?.env?.SUBMISSIONS_KV;
const url = new URL(Astro.request.url);
const accessKey = url.searchParams.get("key");
const stewardKey = url.searchParams.get("stewardKey");
const requiredStewardKey = Astro.locals.runtime?.env?.STEWARD_KEY;
const buildingId = decodeURIComponent(id ?? "");

const hasAccess = isBuildingAccessValid(buildingId, accessKey, Astro.locals.runtime?.env ?? {});
const isSteward = isAccessKeyValid(stewardKey, requiredStewardKey);

const issueIds = new Set(issueOptions.map((issue) => issue.id));
const statusIds: SubmissionStatus[] = ["open", "resolved", "archived"];

const issueFilterRaw = url.searchParams.get("issue") || "all";
const issueFilter = issueIds.has(issueFilterRaw) ? issueFilterRaw : "all";
const statusFilterRaw = url.searchParams.get("status") || "all";
const statusFilter = statusIds.includes(statusFilterRaw as SubmissionStatus) ? statusFilterRaw : "all";
const hasFilters = issueFilter !== "all" || statusFilter !== "all";

const keyParam = accessKey ? `key=${encodeURIComponent(accessKey)}` : "";
const stewardParam = stewardKey ? `stewardKey=${encodeURIComponent(stewardKey)}` : "";
const baseQuery = [keyParam, stewardParam].filter(Boolean).join("&");
const linkSuffix = baseQuery ? `?${baseQuery}` : "";
const clearFiltersUrl = `/buildings/${encodeURIComponent(buildingId)}${baseQuery ? `?${baseQuery}` : ""}`;

const statusLabels = submissionStatusLabels;

const submissions: BuildingSubmission[] =
  hasAccess && kv && buildingId
    ? await loadBuildingSubmissions({ kv, buildingId })
    : [];

const filtered = submissions
  .filter((record) => (issueFilter === "all" ? true : record.issue === issueFilter))
  .filter((record) => (statusFilter === "all" ? true : record.status === statusFilter))
  .sort((left, right) => right.createdAt.localeCompare(left.createdAt));

const maxVisible = 60;
const visibleSubmissions = filtered.slice(0, maxVisible);

const grouped: Record<SubmissionStatus, BuildingSubmission[]> = {
  open: [],
  resolved: [],
  archived: [],
};

for (const record of visibleSubmissions) {
  grouped[record.status].push(record);
}

const totalVisible = visibleSubmissions.length;
const totalFiltered = filtered.length;
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <SeoHead
      title="Building dashboard | Building Ledger"
      description="Private building dashboard for resident issue summaries."
      canonicalPath={`/buildings/${encodeURIComponent(buildingId)}`}
      noindex={true}
    />
  </head>
  <body>
    <div class="page">
      <a class="skip-link" href="#main">Skip to main content</a>
      <header class="hero">
        <div class="hero-main">
          <p class="eyebrow">Building ledger</p>
          <h1>Resident dashboard</h1>
          <p class="tagline">
            See recent reports by status. Add “Me too” with one click.
          </p>
          <div class="tag-row">
            <span>Building: {buildingId || "Not listed"}</span>
            <span>Access: {hasAccess ? "Resident key verified" : "Access key needed"}</span>
            <span>Mode: {isSteward ? "Steward" : "Resident"}</span>
          </div>
        </div>
        <div class="contact-panel">
          <h2>Safety reminder</h2>
          <p class="helper">Keep it short. No names or unit numbers.</p>
          <p class="helper">Evidence is private and hidden here.</p>
        </div>
      </header>

      <main class="layout" id="main">
        <section class="panel panel-highlight dashboard-grid">
          {!hasAccess ? (
            <div class="access-panel">
              <h2>Key required</h2>
              <p class="helper">Residents only.</p>
              <p class="helper">Ask a steward for the building key.</p>
              <ol class="helper-list">
                <li>Get the building key from a resident steward.</li>
                <li>Add <code>?key=YOUR_KEY</code> to the link.</li>
                <li>Reload to view the dashboard.</li>
              </ol>
              <div class="access-sample">
                <p class="access-sample-title">Example</p>
                <code>?key=YOUR_KEY</code>
                <p class="helper">Put the key at the end.</p>
              </div>
              <p class="access-warning">Do not share the key publicly.</p>
              <a class="button button-secondary" href="/">Back to notice builder</a>
            </div>
          ) : !kv ? (
            <div>
              <h2>Ledger storage is not configured.</h2>
              <p class="helper">Connect the submission store to load building activity.</p>
            </div>
          ) : (
            <>
              <div class="summary-grid">
                <div class="summary-card">
                  <p class="summary-label">Total (filtered)</p>
                  <p class="summary-value">{totalFiltered}</p>
                </div>
                <div class="summary-card">
                  <p class="summary-label">Visible now</p>
                  <p class="summary-value">{totalVisible}</p>
                </div>
                <div class="summary-card">
                  <p class="summary-label">Open</p>
                  <p class="summary-value" data-summary-count="open">{formatResidentReportCount(grouped.open.length)}</p>
                </div>
                <div class="summary-card">
                  <p class="summary-label">{statusLabels.resolved}</p>
                  <p class="summary-value" data-summary-count="resolved">{formatResidentReportCount(grouped.resolved.length)}</p>
                </div>
                <div class="summary-card">
                  <p class="summary-label">Archived</p>
                  <p class="summary-value" data-summary-count="archived">{formatResidentReportCount(grouped.archived.length)}</p>
                </div>
              </div>

              <div>
                <h2>Recent submissions</h2>
                <p class="helper">Showing {totalVisible} of {totalFiltered} submissions.</p>
                <p class="helper">Use the filters on the right to change this list.</p>
              </div>

              {totalFiltered === 0 ? (
                <p class="helper">No submissions match these filters.</p>
              ) : (
                statusIds.map((status) => (
                  <section class="status-group" data-status-group={status}>
                    <div class="status-header">
                      <h3>{statusLabels[status]}</h3>
                      <span class="status-pill" data-status-count={status}>{formatResidentReportCount(grouped[status].length)}</span>
                    </div>
                    {grouped[status].length === 0 ? (
                      <p class="helper">No submissions in this status.</p>
                    ) : (
                      grouped[status].map((record) => (
                        <article class="issue-card" data-submission-id={record.id} data-current-status={record.status}>
                          <div>
                            <p class="issue-title">{record.issueLabel}</p>
                            <p class="issue-meta">
                              Started {record.startDate || "Date not listed"}. Reports:{" "}
                              <span data-report-count={record.id}>{formatResidentReportCount(record.reportCount)}</span>.
                            </p>
                            <p class="issue-meta">
                              Last update saved on {record.reportDate || record.createdAt || "Date not listed"}.
                            </p>
                          </div>
                          <div class="issue-actions">
                            <button
                              class="button button-compact"
                              type="button"
                              data-report-button
                              data-submission-id={record.id}
                              data-default-label="Me too"
                            >
                              Me too
                            </button>
                            <a
                              class="button button-secondary button-compact"
                              href={`/submissions/${record.id}${linkSuffix}`}
                            >
                              View details
                            </a>
                          </div>
                          <p class="helper" data-report-status={record.id} role="status" aria-live="polite"></p>
                          {isSteward && (
                            <div class="steward-row">
                              <label class="steward-inline">
                                <span>Update status</span>
                                <select
                                  class="input"
                                  data-status-select
                                  data-submission-id={record.id}
                                >
                                  {statusIds.map((option) => (
                                    <option value={option} selected={record.status === option}>
                                      {statusLabels[option]}
                                    </option>
                                  ))}
                                </select>
                                <button
                                  class="button button-compact"
                                  type="button"
                                  data-status-save
                                  data-submission-id={record.id}
                                  data-default-label="Save"
                                >
                                  Save
                                </button>
                              </label>
                              <p class="helper" data-status-note={record.id} role="status" aria-live="polite"></p>
                            </div>
                          )}
                        </article>
                      ))
                    )}
                  </section>
                ))
              )}
            </>
          )}
        </section>

        <aside class="panel sidebar-panel">
          {!hasAccess ? (
            <>
              <div>
                <h2>Access help</h2>
                <p class="helper">Keys keep resident reports private.</p>
              </div>
              <ol class="helper-list">
                <li>Get the building key from a resident steward.</li>
                <li>Add <code>?key=YOUR_KEY</code> to this link.</li>
                <li>Reload to view filters and reports.</li>
              </ol>
              <div class="export-block">
                <h3>Safety notes</h3>
                <ul class="submission-detail-list">
                  <li>This page never shows names or unit numbers.</li>
                  <li>Evidence files stay private.</li>
                </ul>
              </div>
            </>
          ) : (
            <>
              <div>
                <h2>Filters</h2>
                <p class="helper">Filter by issue type or status.</p>
              </div>
              <form class="filter-grid" method="get">
                {accessKey && <input type="hidden" name="key" value={accessKey} />}
                {stewardKey && <input type="hidden" name="stewardKey" value={stewardKey} />}
                <label>
                  <span>Issue type</span>
                  <select class="input" name="issue">
                    <option value="all" selected={issueFilter === "all"}>All issues</option>
                    {issueOptions.map((issue) => (
                      <option value={issue.id} selected={issueFilter === issue.id}>
                        {issue.label}
                      </option>
                    ))}
                  </select>
                </label>
                <label>
                  <span>Status</span>
                  <select class="input" name="status">
                    <option value="all" selected={statusFilter === "all"}>All statuses</option>
                    {statusIds.map((status) => (
                      <option value={status} selected={statusFilter === status}>
                        {statusLabels[status]}
                      </option>
                    ))}
                  </select>
                </label>
                <button class="button" type="submit">Apply filters</button>
                {hasFilters && (
                  <a class="button button-secondary" href={clearFiltersUrl}>
                    Clear filters
                  </a>
                )}
              </form>
              <div class="export-block">
                <h3>Notes</h3>
                <ul class="submission-detail-list">
                  <li>Use “Me too” to add your report without writing.</li>
                  <li>Stewards can update status for clean records.</li>
                  <li>Counts are resident-reported and not verified.</li>
                </ul>
              </div>
            </>
          )}
        </aside>
      </main>

      <footer class="site-footer">
        <p>Safety first: this dashboard does not show names, unit numbers, or evidence files.</p>
      </footer>
    </div>

    {hasAccess && kv && (
      <>
        <script define:vars={{ stewardKey, isSteward, accessKey }}>
          window.__BUILDING_DASHBOARD__ = {
            stewardKey: stewardKey || "",
            isSteward,
            accessKey: accessKey || "",
          };
        </script>
        <script type="module" src={Astro.resolve("../../scripts/buildingDashboard.ts")}></script>
      </>
    )}
  </body>
</html>
